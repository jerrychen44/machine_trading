import pandas as pd
pd.set_option('display.height', 1000)
pd.set_option('display.max_rows', 500)
pd.set_option('display.max_columns', 500)
pd.set_option('display.width', 1000)
import pandas.io.data as web   # Package and modules for importing data; this code may change depending on pandas version
import datetime,sys

import matplotlib.pyplot as plt   # Import matplotlib
#for candlestick
from matplotlib.dates import DateFormatter, WeekdayLocator,DayLocator, MONDAY,date2num
from matplotlib.finance import candlestick_ohlc



# Let's use NumPy's log function, though math's log function would work just as well
import numpy as np




def get_the_stock_data(stock_name):

    # We will look at stock prices over the past year, starting at January 1, 2016
    start = datetime.datetime(2010,6,1)
    #end = datetime.date.today()
    end =datetime.datetime(2016,11,30)

    # Let's get Apple stock data; Apple's ticker symbol is AAPL
    # First argument is the series we want, second is the source ("yahoo" for Yahoo! Finance), third is the start date, fourth is the end date
    stock_data_df = web.DataReader(stock_name, "yahoo", start, end)
    print(stock_data_df.head(),len(stock_data_df),type(stock_data_df))
    return stock_data_df


def plot_the_stock_line(stock_data_df):
    import matplotlib.pyplot as plt   # Import matplotlib
    # This line is necessary for the plot to appear in a Jupyter notebook
    #matplotlib inline
    # Control the default size of figures in this Jupyter notebook
    #pylab inline
    #pylab.rcParams['figure.figsize'] = (15, 9)   # Change the size of plots

    stock_data_df["Adj Close"].plot(grid = True) # Plot the adjusted closing price of AAPL
    plt.show()
    return 0




def pandas_candlestick_ohlc(dat, stick = "day", otherseries = None):

    """
    :param dat: pandas DataFrame object with datetime64 index, and float columns "Open", "High", "Low", and "Close", likely created via DataReader from "yahoo"
    :param stick: A string or number indicating the period of time covered by a single candlestick. Valid string inputs include "day", "week", "month", and "year", ("day" default), and any numeric input indicates the number of trading days included in a period
    :param otherseries: An iterable that will be coerced into a list, containing the columns of dat that hold other series to be plotted as lines

    This will show a Japanese candlestick plot for stock data stored in dat, also plotting other series if passed.
    """
    mondays = WeekdayLocator(MONDAY)        # major ticks on the mondays
    alldays = DayLocator()              # minor ticks on the days
    dayFormatter = DateFormatter('%d')      # e.g., 12

    # Create a new DataFrame which includes OHLC data for each period specified by stick input
    transdat = dat.loc[:,["Open", "High", "Low", "Close"]]
    if (type(stick) == str):
        if stick == "day":
            plotdat = transdat
            stick = 1 # Used for plotting
        elif stick in ["week", "month", "year"]:
            if stick == "week":
                transdat["week"] = pd.to_datetime(transdat.index).map(lambda x: x.isocalendar()[1]) # Identify weeks
            elif stick == "month":
                transdat["month"] = pd.to_datetime(transdat.index).map(lambda x: x.month) # Identify months
            transdat["year"] = pd.to_datetime(transdat.index).map(lambda x: x.isocalendar()[0]) # Identify years
            grouped = transdat.groupby(list(set(["year",stick]))) # Group by year and other appropriate variable
            plotdat = pd.DataFrame({"Open": [], "High": [], "Low": [], "Close": []}) # Create empty data frame containing what will be plotted
            for name, group in grouped:
                plotdat = plotdat.append(pd.DataFrame({"Open": group.iloc[0,0],
                                            "High": max(group.High),
                                            "Low": min(group.Low),
                                            "Close": group.iloc[-1,3]},
                                           index = [group.index[0]]))
            if stick == "week": stick = 5
            elif stick == "month": stick = 30
            elif stick == "year": stick = 365

    elif (type(stick) == int and stick >= 1):
        transdat["stick"] = [np.floor(i / stick) for i in range(len(transdat.index))]
        grouped = transdat.groupby("stick")
        plotdat = pd.DataFrame({"Open": [], "High": [], "Low": [], "Close": []}) # Create empty data frame containing what will be plotted
        for name, group in grouped:
            plotdat = plotdat.append(pd.DataFrame({"Open": group.iloc[0,0],
                                        "High": max(group.High),
                                        "Low": min(group.Low),
                                        "Close": group.iloc[-1,3]},
                                       index = [group.index[0]]))

    else:
        raise ValueError('Valid inputs to argument "stick" include the strings "day", "week", "month", "year", or a positive integer')


    # Set plot parameters, including the axis object ax used for plotting
    fig, ax = plt.subplots()
    fig.subplots_adjust(bottom=0.2)
    if plotdat.index[-1] - plotdat.index[0] < pd.Timedelta('730 days'):
        weekFormatter = DateFormatter('%b %d')  # e.g., Jan 12
        ax.xaxis.set_major_locator(mondays)
        ax.xaxis.set_minor_locator(alldays)
    else:
        weekFormatter = DateFormatter('%b %d, %Y')
    ax.xaxis.set_major_formatter(weekFormatter)

    ax.grid(True)

    # Create the candelstick chart
    candlestick_ohlc(ax, list(zip(list(date2num(plotdat.index.tolist())), plotdat["Open"].tolist(), plotdat["High"].tolist(),
                      plotdat["Low"].tolist(), plotdat["Close"].tolist())),
                      colorup = "black", colordown = "red", width = stick * .4)

    # Plot other series (such as moving averages) as lines
    if otherseries != None:
        if type(otherseries) != list:
            otherseries = [otherseries]
        dat.loc[:,otherseries].plot(ax = ax, lw = 1.3, grid = True)

    ax.xaxis_date()
    ax.autoscale_view()
    plt.setp(plt.gca().get_xticklabels(), rotation=45, horizontalalignment='right')

    plt.show()
    return 0




def check_one_stock(stock_id):
    stock_data_df=get_the_stock_data(stock_id)

    #plot_the_stock_line(stock_data_df)

    #pandas_candlestick_ohlc(stock_data_df)
    return stock_data_df

def check_multi_stock():

    # We will look at stock prices over the past year, starting at January 1, 2016
    start = datetime.datetime(2016,1,1)
    end = datetime.date.today()

    apple = web.DataReader("AAPL", "yahoo", start, end)
    microsoft = web.DataReader("MSFT", "yahoo", start, end)
    google = web.DataReader("GOOG", "yahoo", start, end)

    # Below I create a DataFrame consisting of the adjusted closing price of these stocks, first by making a list of these objects and using the join method
    stocks = pd.DataFrame({"AAPL": apple["Adj Close"],
                          "MSFT": microsoft["Adj Close"],
                          "GOOG": google["Adj Close"]})

    print(stocks.head())


    #below plot is not right,due to price is different, need normization
    #stocks.plot(grid = True)
    #stocks.plot(secondary_y = ["AAPL", "MSFT"], grid = True)


    # df.apply(arg) will apply the function arg to each column in df, and return a DataFrame with the result
    # Recall that lambda x is an anonymous function accepting parameter x; in this case, x will be a pandas Series object
    stocks_normal_df = stocks.apply(lambda x: x / x[0])
    print(stocks_normal_df.head())

    #plot together
    stocks_normal_df.plot(grid = True).axhline(y = 1, color = "black", lw = 2)
    plt.show()



    return stocks_normal_df

###############
# Feature
###############
def show_the_price_change_speed(stocks_df):
    #in fact, you will want to use growth_t= (price_t+1 - price_t) /price_t
    #or
    #use increase_t = ( price_t - price_t-1) / price_t
    #abovd formula is different and come out difffernet results

    #The advantage of using log differences is that this difference
    #can be interpreted as the percentage change in a stock but does
    #not depend on the denominator of a fraction.


    stock_change_df = stocks_df.apply(lambda x: np.log(x) - np.log(x.shift(1))) # shift moves dates back by 1.
    print(stock_change_df.head())

    #since we have data, plot
    stock_change_df.plot(grid = True).axhline(y = 0, color = "black", lw = 2)
    plt.show()

    return 0

############
# Feature :Moving Averages
###########
def moving_averages(stocks_df):
    start = datetime.datetime(2015,6,1)
    end = datetime.date.today()
    #20 days (1 month) average line
    stocks_df["20d"] = np.round(stocks_df["Close"].rolling(window = 20, center = False).mean(), 2)
    stocks_df["50d"] = np.round(stocks_df["Close"].rolling(window = 50, center = False).mean(), 2)
    stocks_df["200d"] = np.round(stocks_df["Close"].rolling(window = 200, center = False).mean(), 2)
    #plot it out with three avg line
    #pandas_candlestick_ohlc(stocks_df.loc[start:end,:], otherseries  = ["20d", "50d", "200d"])

    #plt.show()
    return stocks_df

def moving_average_strategy(stocks_df):


    ############################
    # Point out the 20d-50d situaltion in every day.
    ###########################
    #add a column for 20d-50d
    stocks_df['20d-50d'] = stocks_df['20d'] - stocks_df['50d']
    print(stocks_df.tail(100))
    '''
                 Open   High   Low  Close    Volume  Adj Close   20d    50d   200d  20d-50d
    Date
    2016-07-13   9.46   9.46  9.46   9.46     53000    9.02230  9.72  10.03  11.01    -0.31
    2016-07-14   9.48   9.48  9.48   9.48     92000    9.04137  9.68  10.02  11.00    -0.34
    2016-07-15   9.63   9.63  9.63   9.63    175000    9.18443  9.66  10.01  10.99    -0.35
    2016-07-18   9.68   9.84  9.65   9.80  25518000    9.34657  9.65  10.00  10.98    -0.35
    2016-07-19   9.85   9.86  9.72   9.85  19269000    9.39425  9.64   9.99  10.98    -0.35
    2016-07-20   9.90   9.92  9.82   9.92  20901000    9.46102  9.63   9.99  10.97    -0.36
    2016-07-21   9.92  10.05  9.90  10.05  25430000    9.58500  9.63   9.99  10.97    -0.36
    2016-07-22  10.00  10.05  9.84   9.91  30905000    9.45148  9.63   9.99  10.96    -0.36
    2016-07-25   9.64   9.70  9.52   9.57  20724000    9.57000  9.60   9.98  10.95    -0.38
    2016-07-26   9.58   9.58  9.46   9.48  14398000    9.48000  9.58   9.96  10.94    -0.38
    2016-07-27   9.55   9.55  9.47   9.50  11139000    9.50000  9.58   9.95  10.93    -0.37
    2016-07-28   9.51   9.65  9.45   9.61  13125000    9.61000  9.58   9.94  10.92    -0.36
    2016-07-29   9.56   9.58  9.40   9.40  16177000    9.40000  9.56   9.93  10.91    -0.37
    2016-08-01   9.45   9.59  9.44   9.55  16416000    9.55000  9.56   9.92  10.90    -0.36
    2016-08-02   9.60   9.60  9.50   9.52  12289000    9.52000  9.56   9.91  10.88    -0.35
    2016-08-03   9.49   9.58  9.46   9.55   9281000    9.55000  9.57   9.90  10.87    -0.33
    2016-08-04   9.59   9.59  9.48   9.54   7958000    9.54000  9.59   9.88  10.86    -0.29
    2016-08-05   9.56   9.58  9.50   9.56   8306000    9.56000  9.60   9.86  10.85    -0.26
    2016-08-08   9.57   9.57  9.45   9.46  14889000    9.46000  9.61   9.84  10.84    -0.23
    2016-08-09   9.55   9.55  9.45   9.49  10066000    9.49000  9.62   9.83  10.83    -0.21
    2016-08-10   9.49   9.53  9.40   9.40  13306000    9.40000  9.61   9.81  10.81    -0.20
    2016-08-11   9.41   9.50  9.40   9.50  14788000    9.50000  9.61   9.79  10.80    -0.18
    2016-08-12   9.51   9.56  9.50   9.51  21302000    9.51000  9.61   9.77  10.79    -0.16
    2016-08-15   9.52   9.59  9.51   9.59   9451000    9.59000  9.60   9.75  10.78    -0.15
    2016-08-16   9.56   9.56  9.46   9.51   8926000    9.51000  9.58   9.74  10.77    -0.16
    2016-08-17   9.46   9.48  9.40   9.40  14617000    9.40000  9.55   9.72  10.75    -0.17
    2016-08-18   9.40   9.47  9.40   9.46   4053000    9.46000  9.53   9.70  10.74    -0.17
    2016-08-19   9.46   9.47  9.26   9.30  14780000    9.30000  9.49   9.67  10.73    -0.18
    2016-08-22   9.30   9.31  9.17   9.17  12181000    9.17000  9.47   9.65  10.72    -0.18
    2016-08-23   9.19   9.27  9.19   9.20   8157000    9.20000  9.46   9.63  10.71    -0.17
    2016-08-24   9.24   9.24  9.17   9.20   6887000    9.20000  9.45   9.61  10.70    -0.16
    2016-08-25   9.20   9.27  9.18   9.25   9246000    9.25000  9.43   9.59  10.69    -0.16
    2016-08-26   9.27   9.29  9.22   9.28   6416000    9.28000  9.42   9.58  10.68    -0.16
    2016-08-29   9.27   9.29  9.21   9.27   7648000    9.27000  9.41   9.56  10.67    -0.15
    2016-08-30   9.29   9.30  9.27   9.28   6049000    9.28000  9.40   9.54  10.66    -0.14
    2016-08-31   9.29   9.29  9.21   9.22  11057000    9.22000  9.38   9.53  10.65    -0.15
    2016-09-01   9.21   9.26  9.19   9.25   5725000    9.25000  9.36   9.51  10.64    -0.15
    2016-09-02   9.38   9.49  9.38   9.42  16208000    9.42000  9.36   9.50  10.63    -0.14
    2016-09-05   9.44   9.48  9.40   9.42   6019000    9.42000  9.36   9.49  10.63    -0.13
    2016-09-06   9.42   9.49  9.40   9.47   8723000    9.47000  9.35   9.48  10.62    -0.13
    2016-09-07   9.50   9.57  9.50   9.56   9929000    9.56000  9.36   9.48  10.61    -0.12
    2016-09-08   9.56   9.64  9.51   9.63  11909000    9.63000  9.37   9.48  10.61    -0.11
    2016-09-09   9.60   9.60  9.50   9.56   6677000    9.56000  9.37   9.48  10.60    -0.11
    2016-09-12   9.43   9.43  9.35   9.38  10013000    9.38000  9.36   9.47  10.59    -0.11
    2016-09-13   9.38   9.39  9.25   9.30   6467000    9.30000  9.35   9.47  10.58    -0.12
    2016-09-14   9.28   9.36  9.27   9.30   5910000    9.30000  9.35   9.46  10.58    -0.11
    2016-09-15   9.30   9.30  9.30   9.30         0    9.30000  9.34   9.47  10.57    -0.13
    2016-09-16   9.30   9.30  9.30   9.30         0    9.30000  9.34   9.47  10.56    -0.13
    2016-09-19   9.28   9.40  9.28   9.36   6202000    9.36000  9.35   9.47  10.55    -0.12
    2016-09-20   9.37   9.47  9.37   9.45   6412000    9.45000  9.36   9.47  10.54    -0.11
    2016-09-21   9.45   9.49  9.38   9.48   4602000    9.48000  9.37   9.47  10.54    -0.10
    2016-09-22   9.50   9.51  9.39   9.46   5092000    9.46000  9.38   9.47  10.53    -0.09
    2016-09-23   9.44   9.57  9.44   9.52  10602000    9.52000  9.40   9.47  10.52    -0.07
    2016-09-26   9.56   9.56  9.44   9.44   5964000    9.44000  9.40   9.46  10.51    -0.06
    2016-09-27   9.44   9.44  9.44   9.44         0    9.44000  9.41   9.45  10.50    -0.04
    2016-09-28   9.44   9.44  9.44   9.44         0    9.44000  9.42   9.44  10.49    -0.02
    2016-09-29   9.49   9.55  9.47   9.50   8310000    9.50000  9.44   9.43  10.48     0.01
    2016-09-30   9.45   9.46  9.35   9.39   8456000    9.39000  9.43   9.42  10.47     0.01
    2016-10-03   9.41   9.42  9.36   9.38   4142000    9.38000  9.43   9.42  10.46     0.01
    2016-10-04   9.37   9.48  9.37   9.48   5141000    9.48000  9.43   9.42  10.44     0.01
    2016-10-05   9.48   9.48  9.42   9.45   2826000    9.45000  9.43   9.42  10.43     0.01
    2016-10-06   9.45   9.50  9.42   9.50   5657000    9.50000  9.42   9.42  10.42     0.00
    2016-10-07   9.50   9.50  9.41   9.44   3837000    9.44000  9.42   9.42  10.41     0.00
    2016-10-10   9.44   9.44  9.44   9.44         0    9.44000  9.42   9.41  10.39     0.01
    2016-10-11   9.50   9.50  9.36   9.39   5559000    9.39000  9.42   9.41  10.38     0.01
    2016-10-12   9.36   9.45  9.35   9.43   4608000    9.43000  9.43   9.41  10.37     0.02
    2016-10-13   9.44   9.44  9.36   9.40   4974000    9.40000  9.43   9.41  10.36     0.02
    2016-10-14   9.40   9.40  9.34   9.35   5683000    9.35000  9.44   9.40  10.35     0.04
    2016-10-17   9.34   9.35  9.25   9.29   5556000    9.29000  9.43   9.40  10.34     0.03
    2016-10-18   9.28   9.43  9.28   9.38   6036000    9.38000  9.43   9.40  10.33     0.03
    2016-10-19   9.41   9.41  9.38   9.40   3575000    9.40000  9.43   9.40  10.32     0.03
    2016-10-20   9.40   9.42  9.36   9.42   5323000    9.42000  9.42   9.40  10.31     0.02
    2016-10-21   9.42   9.55  9.37   9.44  25038000    9.44000  9.42   9.39  10.30     0.03
    2016-10-24   9.46   9.50  9.40   9.42   6675000    9.42000  9.42   9.39  10.29     0.03
    2016-10-25   9.42   9.45  9.37   9.38   4742000    9.38000  9.42   9.39  10.28     0.03
    2016-10-26   9.38   9.40  9.35   9.36   5508000    9.36000  9.41   9.39  10.27     0.02
    2016-10-27   9.37   9.47  9.37   9.39   8675000    9.39000  9.41   9.39  10.26     0.02
    2016-10-28   9.40   9.43  9.34   9.39   6898000    9.39000  9.41   9.39  10.25     0.02
    2016-10-31   9.37   9.64  9.26   9.55  14547000    9.55000  9.41   9.40  10.24     0.01
    2016-11-01   9.55   9.61  9.47   9.60  12114000    9.60000  9.42   9.40  10.24     0.02
    2016-11-02   9.57   9.57  9.43   9.47   6687000    9.47000  9.42   9.41  10.23     0.01
    2016-11-03   9.47   9.51  9.37   9.40   5076000    9.40000  9.42   9.41  10.22     0.01
    2016-11-04   9.40   9.40  9.34   9.35   6219000    9.35000  9.41   9.41  10.21     0.00
    2016-11-07   9.37   9.42  9.36   9.39   4743000    9.39000  9.41   9.42  10.20    -0.01
    2016-11-08   9.40   9.40  9.33   9.38   5153000    9.38000  9.41   9.42  10.19    -0.01
    2016-11-09   9.40   9.42  9.16   9.16  11273000    9.16000  9.40   9.42  10.18    -0.02
    2016-11-10   9.26   9.33  9.26   9.28   4910000    9.28000  9.39   9.42  10.17    -0.03
    2016-11-11   9.25   9.25  9.15   9.19  11161000    9.19000  9.38   9.41  10.16    -0.03
    2016-11-14   9.20   9.25  9.17   9.25   5871000    9.25000  9.38   9.41  10.15    -0.03
    2016-11-15   9.23   9.24  9.17   9.19   6363000    9.19000  9.37   9.40  10.14    -0.03
    2016-11-16   9.19   9.25  9.17   9.17   6313000    9.17000  9.36   9.40  10.13    -0.04
    2016-11-17   9.21   9.25  9.17   9.20   7218000    9.20000  9.35   9.39  10.12    -0.04
    2016-11-18   9.18   9.24  9.18   9.24   4587000    9.24000  9.34   9.38  10.11    -0.04
    2016-11-21   9.25   9.27  9.23   9.27   4651000    9.27000  9.33   9.38  10.11    -0.05
    2016-11-22   9.40   9.49  9.34   9.35  16130000    9.35000  9.33   9.38  10.10    -0.05
    2016-11-23   9.41   9.48  9.41   9.46  11762000    9.46000  9.33   9.38  10.09    -0.05
    2016-11-24   9.60  10.30  9.60  10.25  86535000   10.25000  9.38   9.40  10.08    -0.02
    2016-11-25  10.10  10.10  9.77   9.77  40020000    9.77000  9.40   9.41  10.07    -0.01
    2016-11-28   9.78   9.84  9.66   9.68  13759000    9.68000  9.40   9.42  10.06    -0.02
    2016-11-29   9.71   9.76  9.55   9.60  13723000    9.60000  9.40   9.42  10.05    -0.02
    '''


    ####################
    # Direction : 將20d-50d >0 的 表示20d 穿過50d 在上面, 多方, Direction =1, else =-1 空方, 如果20d-50d=0, 沒方向=0
    ###################
    stocks_df["Direction"] = np.where(stocks_df['20d-50d'] > 0, 1, 0) # if condition is true, set to 1, esle set to 0
    print(stocks_df.tail(100))
    '''
                 Open   High   Low  Close    Volume  Adj Close   20d    50d   200d  20d-50d  Direction
    Date
    2016-07-14   9.48   9.48  9.48   9.48     92000    9.04137  9.68  10.02  11.00    -0.34          0
    2016-07-15   9.63   9.63  9.63   9.63    175000    9.18443  9.66  10.01  10.99    -0.35          0
    2016-07-18   9.68   9.84  9.65   9.80  25518000    9.34657  9.65  10.00  10.98    -0.35          0
    2016-07-19   9.85   9.86  9.72   9.85  19269000    9.39425  9.64   9.99  10.98    -0.35          0
    2016-07-20   9.90   9.92  9.82   9.92  20901000    9.46102  9.63   9.99  10.97    -0.36          0
    2016-07-21   9.92  10.05  9.90  10.05  25430000    9.58500  9.63   9.99  10.97    -0.36          0
    2016-07-22  10.00  10.05  9.84   9.91  30905000    9.45148  9.63   9.99  10.96    -0.36          0
    2016-07-25   9.64   9.70  9.52   9.57  20724000    9.57000  9.60   9.98  10.95    -0.38          0
    2016-07-26   9.58   9.58  9.46   9.48  14398000    9.48000  9.58   9.96  10.94    -0.38          0
    2016-07-27   9.55   9.55  9.47   9.50  11139000    9.50000  9.58   9.95  10.93    -0.37          0
    2016-07-28   9.51   9.65  9.45   9.61  13125000    9.61000  9.58   9.94  10.92    -0.36          0
    2016-07-29   9.56   9.58  9.40   9.40  16177000    9.40000  9.56   9.93  10.91    -0.37          0
    2016-08-01   9.45   9.59  9.44   9.55  16416000    9.55000  9.56   9.92  10.90    -0.36          0
    2016-08-02   9.60   9.60  9.50   9.52  12289000    9.52000  9.56   9.91  10.88    -0.35          0
    2016-08-03   9.49   9.58  9.46   9.55   9281000    9.55000  9.57   9.90  10.87    -0.33          0
    2016-08-04   9.59   9.59  9.48   9.54   7958000    9.54000  9.59   9.88  10.86    -0.29          0
    2016-08-05   9.56   9.58  9.50   9.56   8306000    9.56000  9.60   9.86  10.85    -0.26          0
    2016-08-08   9.57   9.57  9.45   9.46  14889000    9.46000  9.61   9.84  10.84    -0.23          0
    2016-08-09   9.55   9.55  9.45   9.49  10066000    9.49000  9.62   9.83  10.83    -0.21          0
    2016-08-10   9.49   9.53  9.40   9.40  13306000    9.40000  9.61   9.81  10.81    -0.20          0
    2016-08-11   9.41   9.50  9.40   9.50  14788000    9.50000  9.61   9.79  10.80    -0.18          0
    2016-08-12   9.51   9.56  9.50   9.51  21302000    9.51000  9.61   9.77  10.79    -0.16          0
    2016-08-15   9.52   9.59  9.51   9.59   9451000    9.59000  9.60   9.75  10.78    -0.15          0
    2016-08-16   9.56   9.56  9.46   9.51   8926000    9.51000  9.58   9.74  10.77    -0.16          0
    2016-08-17   9.46   9.48  9.40   9.40  14617000    9.40000  9.55   9.72  10.75    -0.17          0
    2016-08-18   9.40   9.47  9.40   9.46   4053000    9.46000  9.53   9.70  10.74    -0.17          0
    2016-08-19   9.46   9.47  9.26   9.30  14780000    9.30000  9.49   9.67  10.73    -0.18          0
    2016-08-22   9.30   9.31  9.17   9.17  12181000    9.17000  9.47   9.65  10.72    -0.18          0
    2016-08-23   9.19   9.27  9.19   9.20   8157000    9.20000  9.46   9.63  10.71    -0.17          0
    2016-08-24   9.24   9.24  9.17   9.20   6887000    9.20000  9.45   9.61  10.70    -0.16          0
    2016-08-25   9.20   9.27  9.18   9.25   9246000    9.25000  9.43   9.59  10.69    -0.16          0
    2016-08-26   9.27   9.29  9.22   9.28   6416000    9.28000  9.42   9.58  10.68    -0.16          0
    2016-08-29   9.27   9.29  9.21   9.27   7648000    9.27000  9.41   9.56  10.67    -0.15          0
    2016-08-30   9.29   9.30  9.27   9.28   6049000    9.28000  9.40   9.54  10.66    -0.14          0
    2016-08-31   9.29   9.29  9.21   9.22  11057000    9.22000  9.38   9.53  10.65    -0.15          0
    2016-09-01   9.21   9.26  9.19   9.25   5725000    9.25000  9.36   9.51  10.64    -0.15          0
    2016-09-02   9.38   9.49  9.38   9.42  16208000    9.42000  9.36   9.50  10.63    -0.14          0
    2016-09-05   9.44   9.48  9.40   9.42   6019000    9.42000  9.36   9.49  10.63    -0.13          0
    2016-09-06   9.42   9.49  9.40   9.47   8723000    9.47000  9.35   9.48  10.62    -0.13          0
    2016-09-07   9.50   9.57  9.50   9.56   9929000    9.56000  9.36   9.48  10.61    -0.12          0
    2016-09-08   9.56   9.64  9.51   9.63  11909000    9.63000  9.37   9.48  10.61    -0.11          0
    2016-09-09   9.60   9.60  9.50   9.56   6677000    9.56000  9.37   9.48  10.60    -0.11          0
    2016-09-12   9.43   9.43  9.35   9.38  10013000    9.38000  9.36   9.47  10.59    -0.11          0
    2016-09-13   9.38   9.39  9.25   9.30   6467000    9.30000  9.35   9.47  10.58    -0.12          0
    2016-09-14   9.28   9.36  9.27   9.30   5910000    9.30000  9.35   9.46  10.58    -0.11          0
    2016-09-15   9.30   9.30  9.30   9.30         0    9.30000  9.34   9.47  10.57    -0.13          0
    2016-09-16   9.30   9.30  9.30   9.30         0    9.30000  9.34   9.47  10.56    -0.13          0
    2016-09-19   9.28   9.40  9.28   9.36   6202000    9.36000  9.35   9.47  10.55    -0.12          0
    2016-09-20   9.37   9.47  9.37   9.45   6412000    9.45000  9.36   9.47  10.54    -0.11          0
    2016-09-21   9.45   9.49  9.38   9.48   4602000    9.48000  9.37   9.47  10.54    -0.10          0
    2016-09-22   9.50   9.51  9.39   9.46   5092000    9.46000  9.38   9.47  10.53    -0.09          0
    2016-09-23   9.44   9.57  9.44   9.52  10602000    9.52000  9.40   9.47  10.52    -0.07          0
    2016-09-26   9.56   9.56  9.44   9.44   5964000    9.44000  9.40   9.46  10.51    -0.06          0
    2016-09-27   9.44   9.44  9.44   9.44         0    9.44000  9.41   9.45  10.50    -0.04          0
    2016-09-28   9.44   9.44  9.44   9.44         0    9.44000  9.42   9.44  10.49    -0.02          0
    2016-09-29   9.49   9.55  9.47   9.50   8310000    9.50000  9.44   9.43  10.48     0.01          1
    2016-09-30   9.45   9.46  9.35   9.39   8456000    9.39000  9.43   9.42  10.47     0.01          1
    2016-10-03   9.41   9.42  9.36   9.38   4142000    9.38000  9.43   9.42  10.46     0.01          1
    2016-10-04   9.37   9.48  9.37   9.48   5141000    9.48000  9.43   9.42  10.44     0.01          1
    2016-10-05   9.48   9.48  9.42   9.45   2826000    9.45000  9.43   9.42  10.43     0.01          1
    2016-10-06   9.45   9.50  9.42   9.50   5657000    9.50000  9.42   9.42  10.42     0.00          0
    2016-10-07   9.50   9.50  9.41   9.44   3837000    9.44000  9.42   9.42  10.41     0.00          0
    2016-10-10   9.44   9.44  9.44   9.44         0    9.44000  9.42   9.41  10.39     0.01          1
    2016-10-11   9.50   9.50  9.36   9.39   5559000    9.39000  9.42   9.41  10.38     0.01          1
    2016-10-12   9.36   9.45  9.35   9.43   4608000    9.43000  9.43   9.41  10.37     0.02          1
    2016-10-13   9.44   9.44  9.36   9.40   4974000    9.40000  9.43   9.41  10.36     0.02          1
    2016-10-14   9.40   9.40  9.34   9.35   5683000    9.35000  9.44   9.40  10.35     0.04          1
    2016-10-17   9.34   9.35  9.25   9.29   5556000    9.29000  9.43   9.40  10.34     0.03          1
    2016-10-18   9.28   9.43  9.28   9.38   6036000    9.38000  9.43   9.40  10.33     0.03          1
    2016-10-19   9.41   9.41  9.38   9.40   3575000    9.40000  9.43   9.40  10.32     0.03          1
    2016-10-20   9.40   9.42  9.36   9.42   5323000    9.42000  9.42   9.40  10.31     0.02          1
    2016-10-21   9.42   9.55  9.37   9.44  25038000    9.44000  9.42   9.39  10.30     0.03          1
    2016-10-24   9.46   9.50  9.40   9.42   6675000    9.42000  9.42   9.39  10.29     0.03          1
    2016-10-25   9.42   9.45  9.37   9.38   4742000    9.38000  9.42   9.39  10.28     0.03          1
    2016-10-26   9.38   9.40  9.35   9.36   5508000    9.36000  9.41   9.39  10.27     0.02          1
    2016-10-27   9.37   9.47  9.37   9.39   8675000    9.39000  9.41   9.39  10.26     0.02          1
    2016-10-28   9.40   9.43  9.34   9.39   6898000    9.39000  9.41   9.39  10.25     0.02          1
    2016-10-31   9.37   9.64  9.26   9.55  14547000    9.55000  9.41   9.40  10.24     0.01          1
    2016-11-01   9.55   9.61  9.47   9.60  12114000    9.60000  9.42   9.40  10.24     0.02          1
    2016-11-02   9.57   9.57  9.43   9.47   6687000    9.47000  9.42   9.41  10.23     0.01          1
    2016-11-03   9.47   9.51  9.37   9.40   5076000    9.40000  9.42   9.41  10.22     0.01          1
    2016-11-04   9.40   9.40  9.34   9.35   6219000    9.35000  9.41   9.41  10.21     0.00          0
    2016-11-07   9.37   9.42  9.36   9.39   4743000    9.39000  9.41   9.42  10.20    -0.01          0
    2016-11-08   9.40   9.40  9.33   9.38   5153000    9.38000  9.41   9.42  10.19    -0.01          0
    2016-11-09   9.40   9.42  9.16   9.16  11273000    9.16000  9.40   9.42  10.18    -0.02          0
    2016-11-10   9.26   9.33  9.26   9.28   4910000    9.28000  9.39   9.42  10.17    -0.03          0
    2016-11-11   9.25   9.25  9.15   9.19  11161000    9.19000  9.38   9.41  10.16    -0.03          0
    2016-11-14   9.20   9.25  9.17   9.25   5871000    9.25000  9.38   9.41  10.15    -0.03          0
    2016-11-15   9.23   9.24  9.17   9.19   6363000    9.19000  9.37   9.40  10.14    -0.03          0
    2016-11-16   9.19   9.25  9.17   9.17   6313000    9.17000  9.36   9.40  10.13    -0.04          0
    2016-11-17   9.21   9.25  9.17   9.20   7218000    9.20000  9.35   9.39  10.12    -0.04          0
    2016-11-18   9.18   9.24  9.18   9.24   4587000    9.24000  9.34   9.38  10.11    -0.04          0
    2016-11-21   9.25   9.27  9.23   9.27   4651000    9.27000  9.33   9.38  10.11    -0.05          0
    2016-11-22   9.40   9.49  9.34   9.35  16130000    9.35000  9.33   9.38  10.10    -0.05          0
    2016-11-23   9.41   9.48  9.41   9.46  11762000    9.46000  9.33   9.38  10.09    -0.05          0
    2016-11-24   9.60  10.30  9.60  10.25  86535000   10.25000  9.38   9.40  10.08    -0.02          0
    2016-11-25  10.10  10.10  9.77   9.77  40020000    9.77000  9.40   9.41  10.07    -0.01          0
    2016-11-28   9.78   9.84  9.66   9.68  13759000    9.68000  9.40   9.42  10.06    -0.02          0
    2016-11-29   9.71   9.76  9.55   9.60  13723000    9.60000  9.40   9.42  10.05    -0.02          0
    2016-11-30   9.67   9.69  9.56   9.56  12323000    9.56000  9.41   9.42  10.04    -0.01          0
    '''
    stocks_df["Direction"] = np.where(stocks_df['20d-50d'] < 0, -1, stocks_df["Direction"])
    print(stocks_df.tail(100))
    '''
                  Open   High   Low  Close    Volume  Adj Close   20d    50d   200d  20d-50d  Direction
    Date
    2016-07-14   9.48   9.48  9.48   9.48     92000    9.04137  9.68  10.02  11.00    -0.34         -1
    2016-07-15   9.63   9.63  9.63   9.63    175000    9.18443  9.66  10.01  10.99    -0.35         -1
    2016-07-18   9.68   9.84  9.65   9.80  25518000    9.34657  9.65  10.00  10.98    -0.35         -1
    2016-07-19   9.85   9.86  9.72   9.85  19269000    9.39425  9.64   9.99  10.98    -0.35         -1
    2016-07-20   9.90   9.92  9.82   9.92  20901000    9.46102  9.63   9.99  10.97    -0.36         -1
    2016-07-21   9.92  10.05  9.90  10.05  25430000    9.58500  9.63   9.99  10.97    -0.36         -1
    2016-07-22  10.00  10.05  9.84   9.91  30905000    9.45148  9.63   9.99  10.96    -0.36         -1
    2016-07-25   9.64   9.70  9.52   9.57  20724000    9.57000  9.60   9.98  10.95    -0.38         -1
    2016-07-26   9.58   9.58  9.46   9.48  14398000    9.48000  9.58   9.96  10.94    -0.38         -1
    2016-07-27   9.55   9.55  9.47   9.50  11139000    9.50000  9.58   9.95  10.93    -0.37         -1
    2016-07-28   9.51   9.65  9.45   9.61  13125000    9.61000  9.58   9.94  10.92    -0.36         -1
    2016-07-29   9.56   9.58  9.40   9.40  16177000    9.40000  9.56   9.93  10.91    -0.37         -1
    2016-08-01   9.45   9.59  9.44   9.55  16416000    9.55000  9.56   9.92  10.90    -0.36         -1
    2016-08-02   9.60   9.60  9.50   9.52  12289000    9.52000  9.56   9.91  10.88    -0.35         -1
    2016-08-03   9.49   9.58  9.46   9.55   9281000    9.55000  9.57   9.90  10.87    -0.33         -1
    2016-08-04   9.59   9.59  9.48   9.54   7958000    9.54000  9.59   9.88  10.86    -0.29         -1
    2016-08-05   9.56   9.58  9.50   9.56   8306000    9.56000  9.60   9.86  10.85    -0.26         -1
    2016-08-08   9.57   9.57  9.45   9.46  14889000    9.46000  9.61   9.84  10.84    -0.23         -1
    2016-08-09   9.55   9.55  9.45   9.49  10066000    9.49000  9.62   9.83  10.83    -0.21         -1
    2016-08-10   9.49   9.53  9.40   9.40  13306000    9.40000  9.61   9.81  10.81    -0.20         -1
    2016-08-11   9.41   9.50  9.40   9.50  14788000    9.50000  9.61   9.79  10.80    -0.18         -1
    2016-08-12   9.51   9.56  9.50   9.51  21302000    9.51000  9.61   9.77  10.79    -0.16         -1
    2016-08-15   9.52   9.59  9.51   9.59   9451000    9.59000  9.60   9.75  10.78    -0.15         -1
    2016-08-16   9.56   9.56  9.46   9.51   8926000    9.51000  9.58   9.74  10.77    -0.16         -1
    2016-08-17   9.46   9.48  9.40   9.40  14617000    9.40000  9.55   9.72  10.75    -0.17         -1
    2016-08-18   9.40   9.47  9.40   9.46   4053000    9.46000  9.53   9.70  10.74    -0.17         -1
    2016-08-19   9.46   9.47  9.26   9.30  14780000    9.30000  9.49   9.67  10.73    -0.18         -1
    2016-08-22   9.30   9.31  9.17   9.17  12181000    9.17000  9.47   9.65  10.72    -0.18         -1
    2016-08-23   9.19   9.27  9.19   9.20   8157000    9.20000  9.46   9.63  10.71    -0.17         -1
    2016-08-24   9.24   9.24  9.17   9.20   6887000    9.20000  9.45   9.61  10.70    -0.16         -1
    2016-08-25   9.20   9.27  9.18   9.25   9246000    9.25000  9.43   9.59  10.69    -0.16         -1
    2016-08-26   9.27   9.29  9.22   9.28   6416000    9.28000  9.42   9.58  10.68    -0.16         -1
    2016-08-29   9.27   9.29  9.21   9.27   7648000    9.27000  9.41   9.56  10.67    -0.15         -1
    2016-08-30   9.29   9.30  9.27   9.28   6049000    9.28000  9.40   9.54  10.66    -0.14         -1
    2016-08-31   9.29   9.29  9.21   9.22  11057000    9.22000  9.38   9.53  10.65    -0.15         -1
    2016-09-01   9.21   9.26  9.19   9.25   5725000    9.25000  9.36   9.51  10.64    -0.15         -1
    2016-09-02   9.38   9.49  9.38   9.42  16208000    9.42000  9.36   9.50  10.63    -0.14         -1
    2016-09-05   9.44   9.48  9.40   9.42   6019000    9.42000  9.36   9.49  10.63    -0.13         -1
    2016-09-06   9.42   9.49  9.40   9.47   8723000    9.47000  9.35   9.48  10.62    -0.13         -1
    2016-09-07   9.50   9.57  9.50   9.56   9929000    9.56000  9.36   9.48  10.61    -0.12         -1
    2016-09-08   9.56   9.64  9.51   9.63  11909000    9.63000  9.37   9.48  10.61    -0.11         -1
    2016-09-09   9.60   9.60  9.50   9.56   6677000    9.56000  9.37   9.48  10.60    -0.11         -1
    2016-09-12   9.43   9.43  9.35   9.38  10013000    9.38000  9.36   9.47  10.59    -0.11         -1
    2016-09-13   9.38   9.39  9.25   9.30   6467000    9.30000  9.35   9.47  10.58    -0.12         -1
    2016-09-14   9.28   9.36  9.27   9.30   5910000    9.30000  9.35   9.46  10.58    -0.11         -1
    2016-09-15   9.30   9.30  9.30   9.30         0    9.30000  9.34   9.47  10.57    -0.13         -1
    2016-09-16   9.30   9.30  9.30   9.30         0    9.30000  9.34   9.47  10.56    -0.13         -1
    2016-09-19   9.28   9.40  9.28   9.36   6202000    9.36000  9.35   9.47  10.55    -0.12         -1
    2016-09-20   9.37   9.47  9.37   9.45   6412000    9.45000  9.36   9.47  10.54    -0.11         -1
    2016-09-21   9.45   9.49  9.38   9.48   4602000    9.48000  9.37   9.47  10.54    -0.10         -1
    2016-09-22   9.50   9.51  9.39   9.46   5092000    9.46000  9.38   9.47  10.53    -0.09         -1
    2016-09-23   9.44   9.57  9.44   9.52  10602000    9.52000  9.40   9.47  10.52    -0.07         -1
    2016-09-26   9.56   9.56  9.44   9.44   5964000    9.44000  9.40   9.46  10.51    -0.06         -1
    2016-09-27   9.44   9.44  9.44   9.44         0    9.44000  9.41   9.45  10.50    -0.04         -1
    2016-09-28   9.44   9.44  9.44   9.44         0    9.44000  9.42   9.44  10.49    -0.02         -1
    2016-09-29   9.49   9.55  9.47   9.50   8310000    9.50000  9.44   9.43  10.48     0.01          1
    2016-09-30   9.45   9.46  9.35   9.39   8456000    9.39000  9.43   9.42  10.47     0.01          1
    2016-10-03   9.41   9.42  9.36   9.38   4142000    9.38000  9.43   9.42  10.46     0.01          1
    2016-10-04   9.37   9.48  9.37   9.48   5141000    9.48000  9.43   9.42  10.44     0.01          1
    2016-10-05   9.48   9.48  9.42   9.45   2826000    9.45000  9.43   9.42  10.43     0.01          1
    2016-10-06   9.45   9.50  9.42   9.50   5657000    9.50000  9.42   9.42  10.42     0.00          0
    2016-10-07   9.50   9.50  9.41   9.44   3837000    9.44000  9.42   9.42  10.41     0.00          0
    2016-10-10   9.44   9.44  9.44   9.44         0    9.44000  9.42   9.41  10.39     0.01          1
    2016-10-11   9.50   9.50  9.36   9.39   5559000    9.39000  9.42   9.41  10.38     0.01          1
    2016-10-12   9.36   9.45  9.35   9.43   4608000    9.43000  9.43   9.41  10.37     0.02          1
    2016-10-13   9.44   9.44  9.36   9.40   4974000    9.40000  9.43   9.41  10.36     0.02          1
    2016-10-14   9.40   9.40  9.34   9.35   5683000    9.35000  9.44   9.40  10.35     0.04          1
    2016-10-17   9.34   9.35  9.25   9.29   5556000    9.29000  9.43   9.40  10.34     0.03          1
    2016-10-18   9.28   9.43  9.28   9.38   6036000    9.38000  9.43   9.40  10.33     0.03          1
    2016-10-19   9.41   9.41  9.38   9.40   3575000    9.40000  9.43   9.40  10.32     0.03          1
    2016-10-20   9.40   9.42  9.36   9.42   5323000    9.42000  9.42   9.40  10.31     0.02          1
    2016-10-21   9.42   9.55  9.37   9.44  25038000    9.44000  9.42   9.39  10.30     0.03          1
    2016-10-24   9.46   9.50  9.40   9.42   6675000    9.42000  9.42   9.39  10.29     0.03          1
    2016-10-25   9.42   9.45  9.37   9.38   4742000    9.38000  9.42   9.39  10.28     0.03          1
    2016-10-26   9.38   9.40  9.35   9.36   5508000    9.36000  9.41   9.39  10.27     0.02          1
    2016-10-27   9.37   9.47  9.37   9.39   8675000    9.39000  9.41   9.39  10.26     0.02          1
    2016-10-28   9.40   9.43  9.34   9.39   6898000    9.39000  9.41   9.39  10.25     0.02          1
    2016-10-31   9.37   9.64  9.26   9.55  14547000    9.55000  9.41   9.40  10.24     0.01          1
    2016-11-01   9.55   9.61  9.47   9.60  12114000    9.60000  9.42   9.40  10.24     0.02          1
    2016-11-02   9.57   9.57  9.43   9.47   6687000    9.47000  9.42   9.41  10.23     0.01          1
    2016-11-03   9.47   9.51  9.37   9.40   5076000    9.40000  9.42   9.41  10.22     0.01          1
    2016-11-04   9.40   9.40  9.34   9.35   6219000    9.35000  9.41   9.41  10.21     0.00          0
    2016-11-07   9.37   9.42  9.36   9.39   4743000    9.39000  9.41   9.42  10.20    -0.01         -1
    2016-11-08   9.40   9.40  9.33   9.38   5153000    9.38000  9.41   9.42  10.19    -0.01         -1
    2016-11-09   9.40   9.42  9.16   9.16  11273000    9.16000  9.40   9.42  10.18    -0.02         -1
    2016-11-10   9.26   9.33  9.26   9.28   4910000    9.28000  9.39   9.42  10.17    -0.03         -1
    2016-11-11   9.25   9.25  9.15   9.19  11161000    9.19000  9.38   9.41  10.16    -0.03         -1
    2016-11-14   9.20   9.25  9.17   9.25   5871000    9.25000  9.38   9.41  10.15    -0.03         -1
    2016-11-15   9.23   9.24  9.17   9.19   6363000    9.19000  9.37   9.40  10.14    -0.03         -1
    2016-11-16   9.19   9.25  9.17   9.17   6313000    9.17000  9.36   9.40  10.13    -0.04         -1
    2016-11-17   9.21   9.25  9.17   9.20   7218000    9.20000  9.35   9.39  10.12    -0.04         -1
    2016-11-18   9.18   9.24  9.18   9.24   4587000    9.24000  9.34   9.38  10.11    -0.04         -1
    2016-11-21   9.25   9.27  9.23   9.27   4651000    9.27000  9.33   9.38  10.11    -0.05         -1
    2016-11-22   9.40   9.49  9.34   9.35  16130000    9.35000  9.33   9.38  10.10    -0.05         -1
    2016-11-23   9.41   9.48  9.41   9.46  11762000    9.46000  9.33   9.38  10.09    -0.05         -1
    2016-11-24   9.60  10.30  9.60  10.25  86535000   10.25000  9.38   9.40  10.08    -0.02         -1
    2016-11-25  10.10  10.10  9.77   9.77  40020000    9.77000  9.40   9.41  10.07    -0.01         -1
    2016-11-28   9.78   9.84  9.66   9.68  13759000    9.68000  9.40   9.42  10.06    -0.02         -1
    2016-11-29   9.71   9.76  9.55   9.60  13723000    9.60000  9.40   9.42  10.05    -0.02         -1
    2016-11-30   9.67   9.69  9.56   9.56  12323000    9.56000  9.41   9.42  10.04    -0.01         -1
    '''



    # Direction -1 is fastavg under slowavg line, +1 is fastaveline above slowavgline

    # plot out
    '''
    stocks_df.loc['2016-01-01':'2016-11-29',"Direction"].plot(ylim = (-2,2)).axhline(y = 0, color = "black", lw = 2)
    plt.show()
    stocks_df["Direction"].plot(ylim = (-2,2)).axhline(y = 0, color = "black", lw = 2)
    plt.show()
    '''

    print(stocks_df["Direction"].value_counts())
    # 簡單說: Regime 就是當時手上應該持有的部位, -1 就是手上應該有空單, 1就是應該要有多單, 0 不持單. 所以 1--> -1 就是手上原來有多單, 平掉轉空單
    # 所以, 在Regime 交替的時候, 就是訊號
    '''
    -1    898 => 空方的時間佔了898天, 但這只是總和, 不是連續
     1    710
     0     72 => 有72天20d-50d = 0, 交叉, 剛好沒方向
    Name: Regime, dtype: int64

    '''


    ############################
    # Generate the trading action(Signal)
    # action: buy=1, sell=-1, close=0
    ###########################


    previouse_direction=stocks_df.ix[0, 'Direction']
    holdpostion=0 # 1,-1,0

    stocks_df['Action']=0 # initial all column to 0
    # We hard code to close Direction at the last day to 0.
    # Then because we set to 0, the Action will set to close.
    real_direction=stocks_df.ix[-1, 'Direction']
    stocks_df.ix[-1, 'Direction']=0.0


    for index, row in stocks_df.iterrows():
        #如果方向和之前不同, 動作, 可能是平倉或是進場
        if row["Direction"] != previouse_direction:
            #手上無單
            if holdpostion ==0:
                #空手進場
                #case1: 0-> 1
                #case2: 0-> -1
                if previouse_direction==0 and row["Direction"]==1:
                    stocks_df.loc[index, 'Action']='Buy'
                    holdpostion=1
                elif previouse_direction==0 and row["Direction"]==-1:
                    stocks_df.loc[index, 'Action']='Sell'
                    holdpostion=-1
            #手上有單
            elif holdpostion !=0:
                #反手進場
                #case1: -1->1
                #case2: 1->-1
                if previouse_direction==-1 and row["Direction"]==1 and holdpostion==-1:
                    stocks_df.loc[index, 'Action']='SClose;Buy'
                    holdpostion=1
                elif previouse_direction==1 and row["Direction"]==-1 and holdpostion==1:
                    stocks_df.loc[index, 'Action']='BClose;Sell'
                    holdpostion=-1
                #出場平倉
                #case1: 1->0
                #case2: -1->0
                elif previouse_direction==1 and row["Direction"]==0 and holdpostion==1:
                        stocks_df.loc[index, 'Action']='BClose'
                        holdpostion=0
                elif previouse_direction==-1 and row["Direction"]==0 and holdpostion==-1:
                        stocks_df.loc[index, 'Action']='SClose'
                        holdpostion=0

        previouse_direction=row["Direction"]

    # write the original Direction back
    stocks_df.ix[-1, 'Direction']=real_direction


    print(stocks_df.tail(100))
    print("TODO: Keep going stocks_df table is fine.")
    sys.exit()

    '''
             Open   High   Low  Close    Volume  Adj Close   20d    50d   200d  20d-50d  Direction      Action
Date
2016-07-14   9.48   9.48  9.48   9.48     92000    9.04137  9.68  10.02  11.00    -0.34       -1.0           0
2016-07-15   9.63   9.63  9.63   9.63    175000    9.18443  9.66  10.01  10.99    -0.35       -1.0           0
2016-07-18   9.68   9.84  9.65   9.80  25518000    9.34657  9.65  10.00  10.98    -0.35       -1.0           0
2016-07-19   9.85   9.86  9.72   9.85  19269000    9.39425  9.64   9.99  10.98    -0.35       -1.0           0
2016-07-20   9.90   9.92  9.82   9.92  20901000    9.46102  9.63   9.99  10.97    -0.36       -1.0           0
2016-07-21   9.92  10.05  9.90  10.05  25430000    9.58500  9.63   9.99  10.97    -0.36       -1.0           0
2016-07-22  10.00  10.05  9.84   9.91  30905000    9.45148  9.63   9.99  10.96    -0.36       -1.0           0
2016-07-25   9.64   9.70  9.52   9.57  20724000    9.57000  9.60   9.98  10.95    -0.38       -1.0           0
2016-07-26   9.58   9.58  9.46   9.48  14398000    9.48000  9.58   9.96  10.94    -0.38       -1.0           0
2016-07-27   9.55   9.55  9.47   9.50  11139000    9.50000  9.58   9.95  10.93    -0.37       -1.0           0
2016-07-28   9.51   9.65  9.45   9.61  13125000    9.61000  9.58   9.94  10.92    -0.36       -1.0           0
2016-07-29   9.56   9.58  9.40   9.40  16177000    9.40000  9.56   9.93  10.91    -0.37       -1.0           0
2016-08-01   9.45   9.59  9.44   9.55  16416000    9.55000  9.56   9.92  10.90    -0.36       -1.0           0
2016-08-02   9.60   9.60  9.50   9.52  12289000    9.52000  9.56   9.91  10.88    -0.35       -1.0           0
2016-08-03   9.49   9.58  9.46   9.55   9281000    9.55000  9.57   9.90  10.87    -0.33       -1.0           0
2016-08-04   9.59   9.59  9.48   9.54   7958000    9.54000  9.59   9.88  10.86    -0.29       -1.0           0
2016-08-05   9.56   9.58  9.50   9.56   8306000    9.56000  9.60   9.86  10.85    -0.26       -1.0           0
2016-08-08   9.57   9.57  9.45   9.46  14889000    9.46000  9.61   9.84  10.84    -0.23       -1.0           0
2016-08-09   9.55   9.55  9.45   9.49  10066000    9.49000  9.62   9.83  10.83    -0.21       -1.0           0
2016-08-10   9.49   9.53  9.40   9.40  13306000    9.40000  9.61   9.81  10.81    -0.20       -1.0           0
2016-08-11   9.41   9.50  9.40   9.50  14788000    9.50000  9.61   9.79  10.80    -0.18       -1.0           0
2016-08-12   9.51   9.56  9.50   9.51  21302000    9.51000  9.61   9.77  10.79    -0.16       -1.0           0
2016-08-15   9.52   9.59  9.51   9.59   9451000    9.59000  9.60   9.75  10.78    -0.15       -1.0           0
2016-08-16   9.56   9.56  9.46   9.51   8926000    9.51000  9.58   9.74  10.77    -0.16       -1.0           0
2016-08-17   9.46   9.48  9.40   9.40  14617000    9.40000  9.55   9.72  10.75    -0.17       -1.0           0
2016-08-18   9.40   9.47  9.40   9.46   4053000    9.46000  9.53   9.70  10.74    -0.17       -1.0           0
2016-08-19   9.46   9.47  9.26   9.30  14780000    9.30000  9.49   9.67  10.73    -0.18       -1.0           0
2016-08-22   9.30   9.31  9.17   9.17  12181000    9.17000  9.47   9.65  10.72    -0.18       -1.0           0
2016-08-23   9.19   9.27  9.19   9.20   8157000    9.20000  9.46   9.63  10.71    -0.17       -1.0           0
2016-08-24   9.24   9.24  9.17   9.20   6887000    9.20000  9.45   9.61  10.70    -0.16       -1.0           0
2016-08-25   9.20   9.27  9.18   9.25   9246000    9.25000  9.43   9.59  10.69    -0.16       -1.0           0
2016-08-26   9.27   9.29  9.22   9.28   6416000    9.28000  9.42   9.58  10.68    -0.16       -1.0           0
2016-08-29   9.27   9.29  9.21   9.27   7648000    9.27000  9.41   9.56  10.67    -0.15       -1.0           0
2016-08-30   9.29   9.30  9.27   9.28   6049000    9.28000  9.40   9.54  10.66    -0.14       -1.0           0
2016-08-31   9.29   9.29  9.21   9.22  11057000    9.22000  9.38   9.53  10.65    -0.15       -1.0           0
2016-09-01   9.21   9.26  9.19   9.25   5725000    9.25000  9.36   9.51  10.64    -0.15       -1.0           0
2016-09-02   9.38   9.49  9.38   9.42  16208000    9.42000  9.36   9.50  10.63    -0.14       -1.0           0
2016-09-05   9.44   9.48  9.40   9.42   6019000    9.42000  9.36   9.49  10.63    -0.13       -1.0           0
2016-09-06   9.42   9.49  9.40   9.47   8723000    9.47000  9.35   9.48  10.62    -0.13       -1.0           0
2016-09-07   9.50   9.57  9.50   9.56   9929000    9.56000  9.36   9.48  10.61    -0.12       -1.0           0
2016-09-08   9.56   9.64  9.51   9.63  11909000    9.63000  9.37   9.48  10.61    -0.11       -1.0           0
2016-09-09   9.60   9.60  9.50   9.56   6677000    9.56000  9.37   9.48  10.60    -0.11       -1.0           0
2016-09-12   9.43   9.43  9.35   9.38  10013000    9.38000  9.36   9.47  10.59    -0.11       -1.0           0
2016-09-13   9.38   9.39  9.25   9.30   6467000    9.30000  9.35   9.47  10.58    -0.12       -1.0           0
2016-09-14   9.28   9.36  9.27   9.30   5910000    9.30000  9.35   9.46  10.58    -0.11       -1.0           0
2016-09-15   9.30   9.30  9.30   9.30         0    9.30000  9.34   9.47  10.57    -0.13       -1.0           0
2016-09-16   9.30   9.30  9.30   9.30         0    9.30000  9.34   9.47  10.56    -0.13       -1.0           0
2016-09-19   9.28   9.40  9.28   9.36   6202000    9.36000  9.35   9.47  10.55    -0.12       -1.0           0
2016-09-20   9.37   9.47  9.37   9.45   6412000    9.45000  9.36   9.47  10.54    -0.11       -1.0           0
2016-09-21   9.45   9.49  9.38   9.48   4602000    9.48000  9.37   9.47  10.54    -0.10       -1.0           0
2016-09-22   9.50   9.51  9.39   9.46   5092000    9.46000  9.38   9.47  10.53    -0.09       -1.0           0
2016-09-23   9.44   9.57  9.44   9.52  10602000    9.52000  9.40   9.47  10.52    -0.07       -1.0           0
2016-09-26   9.56   9.56  9.44   9.44   5964000    9.44000  9.40   9.46  10.51    -0.06       -1.0           0
2016-09-27   9.44   9.44  9.44   9.44         0    9.44000  9.41   9.45  10.50    -0.04       -1.0           0
2016-09-28   9.44   9.44  9.44   9.44         0    9.44000  9.42   9.44  10.49    -0.02       -1.0           0
2016-09-29   9.49   9.55  9.47   9.50   8310000    9.50000  9.44   9.43  10.48     0.01        1.0  BClose;Buy
2016-09-30   9.45   9.46  9.35   9.39   8456000    9.39000  9.43   9.42  10.47     0.01        1.0           0
2016-10-03   9.41   9.42  9.36   9.38   4142000    9.38000  9.43   9.42  10.46     0.01        1.0           0
2016-10-04   9.37   9.48  9.37   9.48   5141000    9.48000  9.43   9.42  10.44     0.01        1.0           0
2016-10-05   9.48   9.48  9.42   9.45   2826000    9.45000  9.43   9.42  10.43     0.01        1.0           0
2016-10-06   9.45   9.50  9.42   9.50   5657000    9.50000  9.42   9.42  10.42     0.00        0.0      BClose
2016-10-07   9.50   9.50  9.41   9.44   3837000    9.44000  9.42   9.42  10.41     0.00        0.0           0
2016-10-10   9.44   9.44  9.44   9.44         0    9.44000  9.42   9.41  10.39     0.01        1.0         Buy
2016-10-11   9.50   9.50  9.36   9.39   5559000    9.39000  9.42   9.41  10.38     0.01        1.0           0
2016-10-12   9.36   9.45  9.35   9.43   4608000    9.43000  9.43   9.41  10.37     0.02        1.0           0
2016-10-13   9.44   9.44  9.36   9.40   4974000    9.40000  9.43   9.41  10.36     0.02        1.0           0
2016-10-14   9.40   9.40  9.34   9.35   5683000    9.35000  9.44   9.40  10.35     0.04        1.0           0
2016-10-17   9.34   9.35  9.25   9.29   5556000    9.29000  9.43   9.40  10.34     0.03        1.0           0
2016-10-18   9.28   9.43  9.28   9.38   6036000    9.38000  9.43   9.40  10.33     0.03        1.0           0
2016-10-19   9.41   9.41  9.38   9.40   3575000    9.40000  9.43   9.40  10.32     0.03        1.0           0
2016-10-20   9.40   9.42  9.36   9.42   5323000    9.42000  9.42   9.40  10.31     0.02        1.0           0
2016-10-21   9.42   9.55  9.37   9.44  25038000    9.44000  9.42   9.39  10.30     0.03        1.0           0
2016-10-24   9.46   9.50  9.40   9.42   6675000    9.42000  9.42   9.39  10.29     0.03        1.0           0
2016-10-25   9.42   9.45  9.37   9.38   4742000    9.38000  9.42   9.39  10.28     0.03        1.0           0
2016-10-26   9.38   9.40  9.35   9.36   5508000    9.36000  9.41   9.39  10.27     0.02        1.0           0
2016-10-27   9.37   9.47  9.37   9.39   8675000    9.39000  9.41   9.39  10.26     0.02        1.0           0
2016-10-28   9.40   9.43  9.34   9.39   6898000    9.39000  9.41   9.39  10.25     0.02        1.0           0
2016-10-31   9.37   9.64  9.26   9.55  14547000    9.55000  9.41   9.40  10.24     0.01        1.0           0
2016-11-01   9.55   9.61  9.47   9.60  12114000    9.60000  9.42   9.40  10.24     0.02        1.0           0
2016-11-02   9.57   9.57  9.43   9.47   6687000    9.47000  9.42   9.41  10.23     0.01        1.0           0
2016-11-03   9.47   9.51  9.37   9.40   5076000    9.40000  9.42   9.41  10.22     0.01        1.0           0
2016-11-04   9.40   9.40  9.34   9.35   6219000    9.35000  9.41   9.41  10.21     0.00        0.0      BClose
2016-11-07   9.37   9.42  9.36   9.39   4743000    9.39000  9.41   9.42  10.20    -0.01       -1.0        Sell
2016-11-08   9.40   9.40  9.33   9.38   5153000    9.38000  9.41   9.42  10.19    -0.01       -1.0           0
2016-11-09   9.40   9.42  9.16   9.16  11273000    9.16000  9.40   9.42  10.18    -0.02       -1.0           0
2016-11-10   9.26   9.33  9.26   9.28   4910000    9.28000  9.39   9.42  10.17    -0.03       -1.0           0
2016-11-11   9.25   9.25  9.15   9.19  11161000    9.19000  9.38   9.41  10.16    -0.03       -1.0           0
2016-11-14   9.20   9.25  9.17   9.25   5871000    9.25000  9.38   9.41  10.15    -0.03       -1.0           0
2016-11-15   9.23   9.24  9.17   9.19   6363000    9.19000  9.37   9.40  10.14    -0.03       -1.0           0
2016-11-16   9.19   9.25  9.17   9.17   6313000    9.17000  9.36   9.40  10.13    -0.04       -1.0           0
2016-11-17   9.21   9.25  9.17   9.20   7218000    9.20000  9.35   9.39  10.12    -0.04       -1.0           0
2016-11-18   9.18   9.24  9.18   9.24   4587000    9.24000  9.34   9.38  10.11    -0.04       -1.0           0
2016-11-21   9.25   9.27  9.23   9.27   4651000    9.27000  9.33   9.38  10.11    -0.05       -1.0           0
2016-11-22   9.40   9.49  9.34   9.35  16130000    9.35000  9.33   9.38  10.10    -0.05       -1.0           0
2016-11-23   9.41   9.48  9.41   9.46  11762000    9.46000  9.33   9.38  10.09    -0.05       -1.0           0
2016-11-24   9.60  10.30  9.60  10.25  86535000   10.25000  9.38   9.40  10.08    -0.02       -1.0           0
2016-11-25  10.10  10.10  9.77   9.77  40020000    9.77000  9.40   9.41  10.07    -0.01       -1.0           0
2016-11-28   9.78   9.84  9.66   9.68  13759000    9.68000  9.40   9.42  10.06    -0.02       -1.0           0
2016-11-29   9.71   9.76  9.55   9.60  13723000    9.60000  9.40   9.42  10.05    -0.02       -1.0           0
2016-11-30   9.67   9.69  9.56   9.56  12323000    9.56000  9.41   9.42  10.04    -0.01       -1.0      SClose
    '''

    '''
    # plot out
    stocks_df["Action"].plot(ylim = (-2, 2))
    plt.show()
    '''
    print(stocks_df["Action"].value_counts())
    '''
    0        1648
    Close      16 =>平倉16次
    Buy         9 =>買多進場9次
    Sell        7
    Name: Action, dtype: int64
    '''
    #Print out the Date and price that every bugy and every sell
    print(stocks_df.loc[stocks_df["Action"] == "Buy", "Close"],len(stocks_df.loc[stocks_df["Action"] == "Buy", "Close"]))
    '''
    Date
    2010-08-09    19.2884
    2011-07-05    19.2390
    2012-10-09    12.2500
    2013-05-28    12.0000
    2013-12-10    10.7000
    2014-05-07    10.2500
    2014-07-21    10.3000
    2015-03-24    16.2000
    2016-10-10     9.4400
    Name: Close, dtype: float64 9
    '''
    print(stocks_df.loc[stocks_df["Action"] == "Sell", "Close"],len(stocks_df.loc[stocks_df["Action"] == "Sell", "Close"]))
    '''
    Date
    2013-02-27    12.20
    2013-06-27    11.20
    2014-02-05    10.50
    2014-05-05    10.15
    2014-06-11    10.10
    2015-11-27    10.90
    2016-11-07     9.39
    Name: Close, dtype: float64 7
    '''
    '''
    # Create a DataFrame with trades, including the price at the trade and the regime under which the trade is made.
    stock_signals = pd.concat([
            pd.DataFrame({"Price": stocks_df.loc[stocks_df["Action"] == "Buy", "Close"],
                         "Action": stocks_df.loc[stocks_df["Action"] == "Buy", "Action"],
                         }),
            pd.DataFrame({"Price": stocks_df.loc[stocks_df["Action"] == "Sell", "Close"],
                         "Action": stocks_df.loc[stocks_df["Action"] == "Sell", "Action"],
                         }),
            pd.DataFrame({#"Price": stocks_df.loc[stocks_df["Action"] == "Sell", "Close"],
                         "End Date": stocks_df["Action"] == "Close", stocks_df[stocks_df.loc[stocks_df["Action"] == "Close"].index],
                         })
        ])
    stock_signals.sort_index(inplace = True)
    print(stock_signals,stock_signals.shape[0])
    sys.exit()
    '''
    '''


    '''


    ###################
    # see the profitability of "long" trades
    #################
    #print((stock_signals["Price"][0]))
    #print(len(stock_signals.loc[(stock_signals["Signal"] == "Buy") & stock_signals["Regime"] == float(1), "Price"]))
    #print((pd.Series(stock_signals["Price"] - stock_signals["Price"].shift(1)).loc[stock_signals.loc[(stock_signals["Signal"].shift(1) == "Buy") & (stock_signals["Regime"].shift(1) == 1)].index].tolist()))
    #print((stock_signals["Price"].loc[stock_signals.loc[(stock_signals["Signal"].shift(1) == "Buy") & (stock_signals["Regime"].shift(1) == 1)].index].index))

    # Let's see the profitability of long trades
    stock_long_profits = pd.DataFrame({

            "Price": stocks_df.loc[(stocks_df["Action"] == "Buy") , "Close"],
            "Action":stocks_df.loc[(stocks_df["Action"] == "Buy") , "Action"],
            "Close Date":stocks_df.loc[(stocks_df["Action"] == "Buy") , "Action"]
            #"Profit": pd.Series(stock_signals["Price"] - stock_signals["Price"].shift(1)).loc[stock_signals.loc[(stock_signals["Signal"].shift(1) == "Buy") & (stock_signals["Regime"].shift(1) == 1)].index].tolist()
            #"End Date": stock_signals["Price"].loc[stock_signals.loc[(stock_signals["Signal"].shift(1) == "Buy") & (stock_signals["Regime"].shift(1) == 1)].index].index
            })
    #stock_long_profits.sort_index(inplace = True)
    print(stock_long_profits,stock_long_profits.shape[0])

    return 0


def main():
    #######################
    #Section 1: Get data
    ########################
    stocks_df=check_one_stock('2610.TW')#'AAPL','2610.TW'

    #stocks_df=check_multi_stock()


    #################
    # Section 2: play some feature
    ##################
    # show change speed
    #show_the_price_change_speed(stocks_df)



    ###################
    # Section3: calulate the moving average
    ###################
    stocks_df=moving_averages(stocks_df)

    #new start for 00_part2_moving_average_trade_example.py
    moving_average_strategy(stocks_df)




    return 0

main()
